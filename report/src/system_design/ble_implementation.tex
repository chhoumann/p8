\subsection{Offline phase}\label{sec:ble_implementation}
Razor pages have tightly-coupled views and controllers, however, we have chosen to separate them in the system diagram, seen in figure~\ref{fig:implementation_diagram}. This is to emphasize the separation of concerns between the view and the controller. The view is responsible for displaying the data, while the controller is responsible for managing the system components. The view handles user interactions, such as such as toggling between listening and non-listening states, and starting or stopping data collection, which it then propagates to the controller.

The system is largely event-driven, which helps decouple the system components. 
Therefore, much of the responsibility of the controller is to subscribe services to events and to handle the events when they are raised thus delegating responsibility across components. 

When the application starts, the \texttt{Beacon Scanner} component will begin listening for Bluetooth devices and add those who match the iBeacon signature to a list of devices.
These devices showed to the user in the view inside of a list.
Each device in the list has a corresponding toggle, letting the user select which devices to use for data collection.
After selecting at least one device, the user can click the "Start listening collection" button, which prompts the \texttt{Data Collector} class to listen for advertisement packets from the selected devices. 
While the \texttt{Data Collector} is actively listening for packets, the \texttt{BeaconRssis} hashtable is continuously populated with the selected beacons' GUIDs and latest RSSI values.


At this point, the data collection process for a given point in the grid may begin.
First, the user must select a label (inside or outside), denoting whether the current point is within or outside the room.
Then, when the user presses the "Collect data" button on the view, the \texttt{Data Collector} class will begin collecting data from the selected beacons.
The data collection process is implemented using standard deviation to account for fluctations.
During data collection, the latest beacon RSSI measurements are added to a collection every 500ms until at least 40 measurements have been made, and the standard deviation is lower than some preset threshold. The collection interval was selected based on a heuristic -- the beacons advertise every 100ms, and therefore 500ms was selected to account for potential delays. However, the 40 measurements threshold was selected arbitrarily.\todo{also based on heuristic actually - the paper from ppl who collected 20s, and collect every 0.5ms for 20s = 40 measurements}
Finally, the sample is added to the data set, and the process can be repeated for the next point in the grid.

For each sampled point, the application writes the data set to a JSON file, which is used by the \texttt{Data Handler} for classification.